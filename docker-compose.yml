services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-accountia}
      MYSQL_USER: ${MYSQL_USER:-accountia}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-accountia}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-accountia_reporting}
      POSTGRES_USER: ${POSTGRES_USER:-accountia}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-accountia}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    depends_on:
      - api-gateway

  api-gateway:
    build: ./api-gateway
    ports:
      - "3001:8080"
    depends_on:
      - auth-ms
      - invoice-ms
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-ms:
    build: ./auth-ms
    ports:
      - "8101:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-accountia}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-accountia}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-accountia}}
    depends_on:
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/auth/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  business-ms:
    build: ./business-ms
    ports:
      - "8102:8080"
    depends_on:
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-accountia}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-accountia}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-accountia}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/business/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  invoice-ms:
    build: ./invoice-ms
    ports:
      - "8103:8080"
    depends_on:
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-accountia}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-accountia}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-accountia}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  expense-ms:
    build: ./expense-ms
    ports:
      - "8104:8080"
    depends_on:
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-accountia}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-accountia}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-accountia}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/expense/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  client-ms:
    build: ./client-ms
    ports:
      - "8105:8080"
    depends_on:
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-accountia}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-accountia}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-accountia}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/client/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  reporting-ms:
    build: ./reporting-ms
    ports:
      - "8200:8000"
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql-data:
  postgres-data:
