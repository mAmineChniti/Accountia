name: CI Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches: ["master", "main"]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx1024m'
  SPRING_SERVICES: 'eureka-server api-gateway auth-ms business-ms client-ms expense-ms invoice-ms'

jobs:
  build-and-test:
    name: Build & Test - ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - eureka-server
          - api-gateway
          - auth-ms
          - business-ms
          - client-ms
          - expense-ms
          - invoice-ms
        include:
          - service: eureka-server
            port: 8761
          - service: api-gateway
            port: 8080
          - service: auth-ms
            port: 8081
          - service: business-ms
            port: 8082
          - service: invoice-ms
            port: 8083
          - service: expense-ms
            port: 8084
          - service: client-ms
            port: 8085
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
          cache-dependency-path: '${{ matrix.service }}/pom.xml'

      - name: Build with Maven
        working-directory: ${{ matrix.service }}
        run: |
          echo "::group::Building ${{ matrix.service }}"
          mvn -B clean package -DskipTests
          echo "::endgroup::"

      - name: Start Spring Boot application
        env:
          SECURITY_JWT_SECRET: ${{ secrets.SECURITY_JWT_SECRET }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          RABBITMQ_HOST: ${{ secrets.RABBITMQ_HOST }}
          RABBITMQ_PORT: ${{ secrets.RABBITMQ_PORT }}
          RABBITMQ_USERNAME: ${{ secrets.RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          KEYCLOAK_ISSUER_URI: ${{ secrets.KEYCLOAK_ISSUER_URI }}
          KEYCLOAK_JWK_SET_URI: ${{ secrets.KEYCLOAK_JWK_SET_URI }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          EUREKA_SERVICE_URL: ${{ secrets.EUREKA_SERVICE_URL }}
        run: |
          echo "Starting ${{ matrix.service }} on port ${{ matrix.port }}"
          cd ${{ matrix.service }}/target
          JAR_FILE=$(ls *.jar | grep -v original | head -1)
          
          # Use H2 database for services that have H2 CI configuration
          if [[ "${{ matrix.service }}" =~ ^(auth-ms|business-ms|client-ms|expense-ms|invoice-ms)$ ]]; then
            DATASOURCE_URL="jdbc:h2:mem:testdb"
            DATASOURCE_USERNAME="sa"
            DATASOURCE_PASSWORD=""
          else
            DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}"
            DATASOURCE_USERNAME="${{ secrets.SPRING_DATASOURCE_USERNAME }}"
            DATASOURCE_PASSWORD="${{ secrets.SPRING_DATASOURCE_PASSWORD }}"
          fi
          
          java -jar "$JAR_FILE" \
            --spring.profiles.active=ci \
            --server.port=${{ matrix.port }} \
            --spring.datasource.url=$DATASOURCE_URL \
            --spring.datasource.username=$DATASOURCE_USERNAME \
            --spring.datasource.password=$DATASOURCE_PASSWORD \
            --spring.jpa.database-platform=org.hibernate.dialect.H2Dialect \
            --spring.jpa.hibernate.ddl-auto=create-drop \
            --eureka.client.enabled=true \
            --eureka.client.register-with-eureka=true \
            --eureka.client.fetch-registry=true \
            --eureka.client.service-url.defaultZone=${{ secrets.EUREKA_SERVICE_URL }} \
            --spring.cloud.discovery.enabled=true \
            --spring.cloud.gateway.server.webflux.discovery.locator.enabled=true \
            > ../app.log 2>&1 &
          
          echo $! > ../app.pid
          echo "Application PID: $(cat ../app.pid)"

      - name: Wait for health endpoint
        run: |
          echo "Waiting for ${{ matrix.service }} health endpoint..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"
            
            if curl -sf http://localhost:${{ matrix.port }}/actuator/health > /dev/null 2>&1; then
              echo "âœ… Health check passed for ${{ matrix.service }}"
              curl -s http://localhost:${{ matrix.port }}/actuator/health | jq . || true
              exit 0
            fi
            
            if [ -f "${{ matrix.service }}/app.pid" ]; then
              PID=$(cat ${{ matrix.service }}/app.pid)
              if ! ps -p $PID > /dev/null 2>&1; then
                echo "âŒ Application process died"
                cat ${{ matrix.service }}/app.log || true
                exit 1
              fi
            fi
            
            sleep 5
          done
          
          echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
          cat ${{ matrix.service }}/app.log || true
          exit 1

      - name: Shutdown application
        if: always()
        run: |
          if [ -f "${{ matrix.service }}/app.pid" ]; then
            kill $(cat ${{ matrix.service }}/app.pid) 2>/dev/null || true
          fi

      - name: Upload error logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-error-logs
          path: ${{ matrix.service }}/app.log
          retention-days: 1

  docker-build:
    name: Docker Build - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      fail-fast: false
      matrix:
        service:
          - eureka-server
          - api-gateway
          - auth-ms
          - business-ms
          - client-ms
          - expense-ms
          - invoice-ms
          - reporting-ms
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify Dockerfile exists
        run: |
          if [ ! -f "${{ matrix.service }}/Dockerfile" ]; then
            echo "âŒ Dockerfile not found in ${{ matrix.service }}/"
            exit 1
          fi
          echo "âœ… Dockerfile found: ${{ matrix.service }}/Dockerfile"

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service }}
          file: ${{ matrix.service }}/Dockerfile
          push: false
          tags: accountia/${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/${{ matrix.service }}.tar

      - name: Verify image was built
        run: |
          docker load --input /tmp/${{ matrix.service }}.tar
          docker images accountia/${{ matrix.service }}:ci-${{ github.sha }}
          echo "âœ… Docker image built successfully: accountia/${{ matrix.service }}:ci-${{ github.sha }}"

  k8s-validation:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -sSLo kubeconform.tar.gz \
            https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Validate Kubernetes manifests with kubeconform
        run: |
          echo "::group::Validating Kubernetes manifests"
          
          ERRORS=0
          
          for manifest in $(find k8s -name "*.yaml" -o -name "*.yml" | sort); do
            echo "Validating: $manifest"
            
            if [[ "$manifest" == *"kustomization.yaml"* ]]; then
              echo "  â­ï¸ Skipping kustomization file"
              continue
            fi
            
            if kubeconform -strict -summary -output json "$manifest" 2>&1; then
              echo "  âœ… Valid"
            else
              echo "  âŒ Invalid"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          echo "::endgroup::"
          
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Found $ERRORS invalid manifest(s)"
            exit 1
          fi
          
          echo "âœ… All Kubernetes manifests are valid"

      - name: Validate with kubectl dry-run
        run: |
          echo "::group::kubectl dry-run validation"
          
          for manifest in $(find k8s -name "*.yaml" -o -name "*.yml" | grep -v kustomization | sort); do
            echo "Dry-run validating: $manifest"
            
            if kubectl apply --dry-run=client -f "$manifest" 2>&1; then
              echo "  âœ… Dry-run passed"
            else
              echo "  âš ï¸ Dry-run warning (may contain template variables)"
            fi
          done
          
          echo "::endgroup::"

      - name: Check for required resources
        run: |
          echo "Checking for required Kubernetes resources..."
          
          REQUIRED_FILES=(
            "k8s/base/namespace.yaml"
            "k8s/base/configmap.yaml"
            "k8s/base/secrets.yaml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done

  config-safety:
    name: Configuration Safety Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for localhost usage in K8s configs
        run: |
          echo "::group::Checking for localhost usage in Kubernetes configs"
          
          # Use a different approach to avoid YAML parsing issues
          LOCALHOST_REFS=""
          for manifest in $(find k8s -name "*.yaml" -o -name "*.yml" | grep -v kustomization | sort); do
            # Check for localhost references (excluding health probes)
            if grep -q "localhost" "$manifest" && ! grep -q -E "(readinessProbe|livenessProbe|startupProbe)" "$manifest"; then
              LOCALHOST_REFS="$LOCALHOST_REFS$manifest: $(grep -n "localhost" "$manifest" | head -1)"
            fi
          done
          
          if [ -n "$LOCALHOST_REFS" ]; then
            echo "âŒ Found localhost references in Kubernetes configs:"
            echo "$LOCALHOST_REFS"
            echo ""
            echo "Replace localhost with Kubernetes service names or environment variables."
            echo "(Note: localhost in health probes is allowed)"
            exit 1
          fi
          
          echo "âœ… No problematic localhost usage found in Kubernetes configs"
          echo "::endgroup::"

      - name: Check for hardcoded secrets
        run: |
          echo "::group::Checking for hardcoded secrets"
          FAILED=0
          
          echo "ðŸ“‹ Checking k8s/base/secrets.yaml for hardcoded secrets..."
          
          if [ -f "k8s/base/secrets.yaml" ]; then
            REAL_SECRETS=$(grep -E "^[[:space:]]+[A-Z_]+:" k8s/base/secrets.yaml | \
              grep -v "REPLACE_ME" | \
              grep -v "^#" | \
              grep -v "_note:" || true)
            
            if [ -n "$REAL_SECRETS" ]; then
              echo "âŒ Hardcoded secrets found in k8s/base/secrets.yaml:"
              echo "$REAL_SECRETS"
              echo "All secret values must use REPLACE_ME_* placeholders"
              FAILED=1
            else
              echo "âœ… k8s/base/secrets.yaml uses placeholder values"
            fi
          fi
          
          echo ""
          echo "ðŸ“‹ Checking application.yml files for hardcoded sensitive defaults..."
          
          SERVICES="eureka-server api-gateway auth-ms business-ms client-ms expense-ms invoice-ms"
          SENSITIVE_PATTERNS="PASSWORD.*:|.*_PASSWORD:.*[^}]$|SECRET.*:.*[^}]$|DATASOURCE_URL.*:.*jdbc:|KEYCLOAK.*URI.*:.*http:"
          
          for service in $SERVICES; do
            CONFIG_FILE="$service/src/main/resources/application.yml"
            if [ -f "$CONFIG_FILE" ]; then
              HARDCODED=$(grep -E "\\\$\{[^}]+:[^}]+\}" "$CONFIG_FILE" | \
                grep -iE "password|secret|credential|_url.*jdbc|keycloak.*uri" | \
                grep -v ':}' || true)
              
              if [ -n "$HARDCODED" ]; then
                echo "âŒ Hardcoded sensitive defaults in $CONFIG_FILE:"
                echo "$HARDCODED"
                FAILED=1
              fi
            fi
          done
          
          if [ $FAILED -eq 0 ]; then
            echo "âœ… No hardcoded sensitive defaults in application.yml files"
          fi
          
          echo ""
          echo "ðŸ“‹ Checking keycloak config for hardcoded credentials..."
          
          if [ -f "keycloak/realm-export.json" ]; then
            if grep -q '"credentials"' keycloak/realm-export.json && \
               grep -q '"value"' keycloak/realm-export.json; then
              echo "âŒ Hardcoded user credentials found in keycloak/realm-export.json"
              echo "Users with passwords should not be in the repository"
              FAILED=1
            else
              echo "âœ… No hardcoded user credentials in keycloak config"
            fi
          fi
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "âŒ SECRET VALIDATION FAILED"
            echo "All secrets must be provided at deployment time, not stored in repository"
            exit 1
          else
            echo "âœ… All secret validation checks passed"
          fi
          
          echo "::endgroup::"

      - name: Validate environment variable references
        run: |
          echo "::group::Validating environment variable references"
          
          # Check that ConfigMap and Secret references exist
          CONFIG_REFS=$(grep -rh "configMapKeyRef:" k8s/services/ -A 2 | grep "name:" | awk '{print $2}' | sort -u || true)
          SECRET_REFS=$(grep -rh "secretKeyRef:" k8s/services/ -A 2 | grep "name:" | awk '{print $2}' | sort -u || true)
          
          echo "ConfigMap references found: $CONFIG_REFS"
          echo "Secret references found: $SECRET_REFS"
          
          # Verify configmap exists
          if echo "$CONFIG_REFS" | grep -q "accountia-config"; then
            if [ -f "k8s/base/configmap.yaml" ]; then
              echo "âœ… accountia-config ConfigMap definition found"
            else
              echo "âŒ accountia-config referenced but not defined"
              exit 1
            fi
          fi
          
          # Verify secrets exist
          if echo "$SECRET_REFS" | grep -q "accountia-secrets"; then
            if [ -f "k8s/base/secrets.yaml" ]; then
              echo "âœ… accountia-secrets Secret definition found"
            else
              echo "âŒ accountia-secrets referenced but not defined"
              exit 1
            fi
          fi
          
          echo "::endgroup::"

      - name: Check Docker Compose configuration
        run: |
          echo "::group::Validating Docker Compose"
          
          if [ -f "docker-compose.yml" ]; then
            docker compose config -q
            echo "âœ… docker-compose.yml is valid"
          else
            echo "âš ï¸ docker-compose.yml not found"
          fi
          
          echo "::endgroup::"

      - name: Verify required application configs
        run: |
          echo "::group::Checking application configurations"
          
          SERVICES="eureka-server api-gateway auth-ms business-ms client-ms expense-ms invoice-ms"
          
          for service in $SERVICES; do
            echo "Checking $service..."
            
            # Check for application.yml or application.properties
            if [ -f "$service/src/main/resources/application.yml" ] || \
               [ -f "$service/src/main/resources/application.yaml" ] || \
               [ -f "$service/src/main/resources/application.properties" ]; then
              echo "  âœ… Application config found"
            else
              echo "  âŒ No application config found in $service"
              exit 1
            fi
            
            # Check for pom.xml
            if [ -f "$service/pom.xml" ]; then
              echo "  âœ… pom.xml found"
            else
              echo "  âŒ pom.xml not found in $service"
              exit 1
            fi
            
            # Check for Dockerfile
            if [ -f "$service/Dockerfile" ]; then
              echo "  âœ… Dockerfile found"
            else
              echo "  âŒ Dockerfile not found in $service"
              exit 1
            fi
          done
          
          echo "::endgroup::"

  # ============================================================================
  # STAGE 5: FINAL SUMMARY
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - build-and-test
      - docker-build
      - k8s-validation
      - config-safety
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          BUILD="${{ needs.build-and-test.result }}"
          DOCKER="${{ needs.docker-build.result }}"
          K8S="${{ needs.k8s-validation.result }}"
          CONFIG="${{ needs.config-safety.result }}"
          
          echo "| Build & Test | $( [ \"$BUILD\" = \"success\" ] && echo \"âœ… Passed\" || echo \"âŒ $BUILD\" ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | $( [ \"$DOCKER\" = \"success\" ] && echo \"âœ… Passed\" || echo \"âŒ $DOCKER\" ) |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Validation | $( [ \"$K8S\" = \"success\" ] && echo \"âœ… Passed\" || echo \"âŒ $K8S\" ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Safety | $( [ \"$CONFIG\" = \"success\" ] && echo \"âœ… Passed\" || echo \"âŒ $CONFIG\" ) |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$BUILD" = "success" ] && [ "$DOCKER" = "success" ] && \
             [ "$K8S" = "success" ] && [ "$CONFIG" = "success" ]; then
            echo "### ðŸŽ‰ All CI checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "The application is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some CI checks failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

